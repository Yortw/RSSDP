name: RSSDP NuGet Publish

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version to publish (e.g., 5.0.0)'
        required: true
      project_path:
        description: 'Path to the csproj to pack (e.g., src/Main/Lib/Rssdp.csproj)'
        required: false
        default: src/Main/Lib/Rssdp.csproj
  release:
    types: [created]

jobs:
  pack-and-publish:
    name: Pack and Publish
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore
        run: dotnet restore ./src/Main/RSSDP.sln

      - name: Build
        run: dotnet build ./src/Main/RSSDP.sln --configuration Release --no-restore

      - name: Determine Version and Project Path
        id: meta
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            # Use release tag name for version, strip leading 'v' if present
            TAG_NAME="${{ github.event.release.tag_name }}"
            VERSION="${TAG_NAME#v}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          PROJECT_PATH="${{ github.event.inputs.project_path }}"
          if [[ -z "$PROJECT_PATH" ]]; then
            PROJECT_PATH="src/Main/Lib/Rssdp.csproj"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "project_path=$PROJECT_PATH" >> $GITHUB_OUTPUT

      - name: Pack
        run: dotnet pack ${{ steps.meta.outputs.project_path }} --configuration Release /p:PackageVersion=${{ steps.meta.outputs.version }} --no-build --output ./artifacts

      - name: Publish to NuGet.org
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: dotnet nuget push "./artifacts/*.nupkg" --source "https://api.nuget.org/v3/index.json" --api-key "$NUGET_API_KEY" --skip-duplicate

      - name: Upload Package Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: ./artifacts
